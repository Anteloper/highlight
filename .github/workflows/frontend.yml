name: Frontend
on:
    push:
        branches:
            - '**'
            - '!master'
        paths:
            - 'packages/frontend/**'
            - '.github/workflows/frontend.yml'
jobs:
    changes:
        runs-on: ubuntu-latest
        # Set job outputs to values from filter step
        outputs:
            gql: ${{ steps.filter.outputs.gql }}
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - uses: dorny/paths-filter@v2
              id: filter
              with:
                  filters: |
                      gql:
                        - 'packages/frontend/src/graph/operators/query.gql'
                        - 'packages/frontend/src/graph/operators/mutation.gql'
    generate-check:
        needs: [changes]
        if: needs.changes.outputs.gql == 'true'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 16.14.2
                  registry-url: https://registry.npmjs.org
                  cache: 'yarn'
            - name: Install dependencies
              run: yarn
            - name: copy frontend
              run: |
                  mkdir tmp
                  cp -a packages/frontend/. tmp/
            - name: Generate code
              run: yarn workspaces foreach frontend run gql:nowatch
            - name: Diff Check
              run: diff -r packages/frontend/src/graph tmp/src/graph
    frontend:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 16.14.2
                  registry-url: https://registry.npmjs.org
                  cache: 'yarn'
            - name: Install dependencies
              run: yarn workspaces foreach frontend install
            - name: Runs linting
              run: yarn workspaces foreach frontend test
            - name: Build Bundle
              run: export NODE_OPTIONS='--max-old-space-size=7168' && CI=false yarn workspaces foreach frontend run build
