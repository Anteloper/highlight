version: 1
applications:
    - appRoot: packages/frontend
      frontend:
          phases:
              preBuild:
                  # https://github.com/aws-amplify/amplify-cli/issues/6382#issuecomment-1145087901
                  commands:
                      - npx pnpm -r --filter=frontend-ts... run build
              build:
                  commands:
                      - (curl -Ls https://cli.doppler.com/install.sh || wget -qO- https://cli.doppler.com/install.sh) | sh
                      - doppler run -- npx pnpm run build
          artifacts:
              baseDirectory: build
              files:
                  - '**/*'
          cache:
              paths:
                  - node_modules/**/*
    - appRoot: packages/client
      frontend:
          phases:
              preBuild:
                  commands:
                      - npx pnpm install
              build:
                  commands:
                      - npx pnpm build
          artifacts:
              baseDirectory: dist
              files:
                  - '**/*'
          cache:
              paths:
                  - node_modules/**/*
